# [way-to-go](https://way-to-go.syall.work/)

## Overview

**way-to-go** is a Desktop PWA Rogue-like Game written with the Canvas API.

## Technical Notes

The entire game is all written on one Canvas which means the entire implementation is done in JavaScript.

Here are some of the design notes about different aspects of the project.

### High DPI Canvas

Because this was my first time using Canvas, I did not realize that High DPI Canvases existed.

Regardless of what I tried, any text that I drew would be completely blurry.

However, after searching over and over for solutions, it turns out there is a `devicePixelRatio` property on the browser `window` that translates how the CSS pixel values translate into actual device pixels.

The final code framework is fairly simple:

```javascript
// High DPI Canvas
const canvas = document.getElementById('canvas');
const dpr = window.devicePixelRatio;
const side = x;
canvas.width = Math.ceil(side * dpr);
canvas.height = Math.ceil(side * dpr);
canvas.style.width = `${canvas.width / dpr}px`;
canvas.style.height = `${canvas.height / dpr}px`;
const ctx = canvas.getContext('2d');
ctx.scale(dpr, dpr);
```

As you can see, there is a difference between the `canvas` properties `width` and `height` as opposed to the `canvas.style` properties `width` and `height`.

Finally, the canvas needs to be scaled to the `devicePixelRatio` in the line `ctx.scale(dpr, dpr)` to look normal again.

### World System

I have not had any prior experience to designing game state, so I tried my hand at encapsulating all of the state in one `world` object.

By itself, the world contains a grid completely filled with walls (which can be carved out later) and the canvas to draw on.

To extend the world, different components can be added with the `addToWorld` function which takes in parameters that set the name, object, and initial code to run after adding the property.

### Dungeon

The dungeon is generated by checking whether random rooms can fit in the grid while also not intersecting with existing rooms.

If these conditions are met, the room is drawn and a path is randomly drawn from the previous room to the current room.

The process is repeated 100,000 times which *should* popolate it completely; however, it still has a problem probably due to a poor implementation of the `rng` function.

### Player

The player entity only has a `pos` property which are the current coordinates.

The main functionality of the player is to determine the player tile as well as movement.

Collision is checked by whether a potential position has a tile type that is included in a predefined array of illegal tiles.

The movement is implemented in event listeners paired with a set which records active keys.

On `keydown`, the key pressed is added to the set and the movement is calculated with the active keys in the set.

On `keyup`, the key is removed from the set so it is not included in the calculations.

Depending on the direction, the player tile changes to corresponding Chinese characters as a fun twist!

### Animation

JavaScript uses the event loop for executing functions so it is difficult to time execution of functions.

This problem became very clear when I tried to line up sequential Canvas animations for the opening scene.

To solve the solution, `scene` is a function that takes in an array of `[time, frame]` which executes the frame at approximately the input time (setTimeout only sets the minimum delay).

All the frames are implemented with a time parameter so they can be executed at that time instead of hard coding `setTimeout` for every animation.

```javascript
scene([
    [0000, frames.start],
    [1000, frames.next],
    // ...
    [8000, frames.end]
])
```

### Service Worker

For the service worker, I essentially minized code from a [tutorial](https://developers.google.com/web/fundamentals/primers/service-workers).

There is an array of files that need to be cached (which are only 6 in number) as well as the code that responds to both installing the PWA and fetching the resources.

There is also an `activate` event that clears the cached files for updates, but I am not sure how to activate it.

### index.js

`index.js` is the entry point of the entire game.

Using the world system, the initial couple lines of code simply adds entities to the world while also initializing the initial world state.

The game animation sequence is created with a series of scenes, but the scene is skipped if it has been recorded that it has been seen before in `sessionStorage`.

Finally, the service worker is registered to make it compatible as a PWA.

## Personal Notes

I always wanted to try game development.

However, after working on this project, I realized I do not like it very much.

The intersection between managing all of these objects in the adhoc system I poorly designed was just a mess.

However, from what I have seen in Unity, the process is relatively similar, although the GUI component may help.

Maybe if I could design a more sophisticated Entity Component System I would enjoy it more, especially since the code I wrote is some of the scrappiest since high school.

To even refactor the functions into a decent final structure was a challenge.

[syall](https://github.com/syall)
